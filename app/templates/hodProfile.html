{% extends "commonLayout.html" %}
{% block content %}

<div class="ui container pt-5 pb-5">

    <form class="ui form p-4" id='Appointment_form'>
        <h3 class="ui dividing header" style="font-family: sans-serif;">Update details</h3>
        <div class="fields three">
          <div class="field">
            <label>Name</label>
            <input id='name' required type="text" placeholder="Name" value="{{ user.name }}">
          </div>
          <div class="field">
            <label>Email</label>
            <input id='email' required type="email" placeholder="Email" value="{{ user.email }}">
          </div>
          <div class="field">
            <label>Secret Code</label>
            <input id='username' required type="text" placeholder="4 Digit Secret Code" value="{{ scode }}">
          </div>
        </div>
  
        <div class="fields two">
          <div class="field">
            <label>Phone Number</label>
            <input id='number' required type="number" value="{{ user.phone_num }}">
          </div>
  
          <div class="field">
            <label>Department</label>
            <input id='department_options' required type="text" disabled value="{{ user.department }}">
          </div>
        </div>
        <button class="ui button teal" id='upload_button' type="submit">Update details</button>
    </form>

    <hr class='rounded' style="height: 5px; background-color: rgb(255, 0, 106);">


    <form class="ui form p-4" id='imageupdate'>
        
        <h3 class="ui dividing header" style="font-family: sans-serif;">Update Verification Image</h3>
        
        <div class="fields three">
            <div class="field">
                <label>Verification Image 1
                <input id='vimage1' required type="file" accept="image/*"capture="camera"></label>
            </div>

            <div class="field">
                <label>Verification Image 2
                  <input id='vimage2' required type="file" accept="image/*"capture="camera">
                </label>
            </div>

            <div class="field pb-2 pb-md-0">
                <label>Verification Image 3
                  <input id='vimage3' required type="file" accept="image/*"capture="camera">
                </label>
            </div>
        </div>

        <div class="pt-2 pb-4" id = 'pro' style="display: none;">
            <div class="progress" style="height: 15px;">
              <div class="progress-bar bg-success rounded" role="progressbar" style="width: 10%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>

        <button class="ui button teal" id='upload_button' type="submit">Update Image</button>
  
    </form>

</div>

<script>

$("#imageupdate").submit((e) => {
    var base = window.location.origin + '/hod/verification_image';
    var form_data = new FormData()
    var username = $('#name').val().toLowerCase().slice(0,3) + String($('#number').val()).slice(7) + $('#username').val()
    form_data.append('username', user_name);
    form_data.append('image1', $('#vimage1')[0].files[0])
    form_data.append('image2', $('#vimage2')[0].files[0])
    form_data.append('image3', $('#vimage3')[0].files[0])
    console.log(form_data)
    $("#upload_button").addClass("loading disabled")
    $("#pro").show()
    $.ajax({
        xhr: function() {
            var xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
              var percentComplete = Math.round((evt.loaded / evt.total) * 100);
              $(".progress-bar").width(percentComplete + '%');
              $(".progress-bar").html(percentComplete+'%');
                }
            }, false);
            return xhr;
        },
        url: base,
        type: 'POST',
        async: true,
        data: form_data,
        cache: false,
    
        contentType: false,
        processData: false,
        beforeSend: function(){
            $(".progress-bar").width('0%');
            $('#uploadStatus').html('<img src="images/loading.gif"/>');
        },
        success: function(result){
            $("#pro").hide()
            swal({
                    text: "Verification Images Updated...",
                    icon: "success",
                    button: "Okay"
                }).then((value) => {
                    location.reload();
            })
        },
        error: function(result){
            if(result.status == 415){
                $("#upload_button").removeClass("loading disabled")
                $("#pro").hide()
                swal({
                    text: "Please retake image...",
                    icon: "warning",
                    button: "Okay"
                })
            }
            else{
                $("#pro").hide()
                swal({
                    text: "Something Went Wrong. Please try to contact the techincal team...",
                    icon: "error",
                    button: "Okay"  
                }).then((value) => {
                    location.reload();
                })   
            }
      
        }
    })
})

</script>

<script>
    $("#Appointment_form").submit((e)=>{
        var name = $('#name').val()
        var email = $('#email').val()
        var phone = $('#number').val()
        var username = $('#username').val()
        var username = name.toLowerCase().slice(0,3) + String(phone).slice(7) + username
        var department = $('#department_options').val()
        var data = JSON.stringify({"name": name, "email": email, "phone_num": phone, "user_name": username, "department": department})

        var base = window.location.origin + '/hod/update_profile';
        $("#upload_button").addClass("loading disabled")
        $.ajax({
            url: base,
            type: 'POST',
            async: true,
            data: data,
            dataType: 'json',
            contentType: "application/json",
            
            success: function(result){
                swal("Working fine")
            },
            error: function(result){
                $("#upload_button").removeClass("loading disabled")
                swal("Not working fine")
            }
        })
    })
</script>

{% endblock %}